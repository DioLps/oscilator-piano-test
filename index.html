<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Interactive Piano</title>
  <link rel="icon"
    href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üéπ</text></svg>">
  <style>
    body {
      font-family: 'Arial', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      margin: 0;
      padding: 20px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .container {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    h1 {
      color: white;
      text-align: center;
      margin-bottom: 10px;
      font-size: 2.5em;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    }

    .controls {
      text-align: center;
      margin-bottom: 30px;
      color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
    }

    .octave-controls {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 10px;
    }

    .octave-btn {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 10px;
      padding: 10px 15px;
      font-size: 1.2em;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s ease;
      user-select: none;
    }

    .octave-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      border-color: rgba(255, 255, 255, 0.5);
      transform: translateY(-2px);
    }

    .octave-btn:active {
      transform: translateY(0px);
      background: rgba(255, 255, 255, 0.4);
    }

    .octave-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .octave-display {
      font-size: 1.4em;
      padding: 12px 25px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 10px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      min-width: 120px;
    }

    .instructions {
      font-size: 0.9em;
      opacity: 0.8;
      margin-bottom: 20px;
    }

    .piano {
      position: relative;
      margin: 20px 0;
      width: 420px;
      /* Fixed width for proper layout */
      height: 200px;
    }

    .key {
      cursor: pointer;
      transition: all 0.1s ease;
      user-select: none;
      border-radius: 0 0 8px 8px;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      padding-bottom: 10px;
      font-weight: bold;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
      position: absolute;
    }

    .key:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .key:active {
      transform: translateY(2px);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .white-key {
      width: 50px;
      height: 200px;
      background: linear-gradient(to bottom, #ffffff, #f0f0f0);
      border: 2px solid #ccc;
      z-index: 1;
      color: #333;
    }

    .black-key {
      width: 30px;
      height: 120px;
      background: linear-gradient(to bottom, #333, #000);
      border: 2px solid #000;
      z-index: 2;
      color: #fff;
      top: 0;
    }

    .playing {
      background: linear-gradient(to bottom, #ff6b6b, #ee5a52) !important;
      transform: translateY(2px);
    }

    .frequency-display {
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 15px;
      border-radius: 10px;
      margin-top: 20px;
      text-align: center;
      font-family: 'Courier New', monospace;
    }

    .current-note {
      font-size: 1.5em;
      margin-bottom: 10px;
    }

    .current-frequency {
      font-size: 1.1em;
      opacity: 0.8;
    }

    .volume-control {
      margin: 20px 0;
      text-align: center;
    }

    .volume-slider {
      width: 200px;
      margin: 0 10px;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>üéπ Interactive Piano</h1>

    <div class="controls">
      <div class="octave-controls">
        <button class="octave-btn" id="octave-down">‚¨áÔ∏è Down</button>
        <div class="octave-display">
          Octave: <span id="current-octave">4</span>
        </div>
        <button class="octave-btn" id="octave-up">‚¨ÜÔ∏è Up</button>
      </div>
      <div class="instructions">
        Use <strong>‚Üë‚Üì arrow keys</strong> or buttons above to change octaves while playing<br>
        <small style="opacity: 0.7;">Click anywhere to enable audio first | Press <strong>Space</strong> to stop
          all notes</small>
      </div>
      <div class="volume-control">
        <label for="volume">Volume: </label>
        <input type="range" id="volume" class="volume-slider" min="0" max="100" value="30">
        <span id="volume-value">30%</span>
      </div>
    </div>

    <div class="piano" id="piano">
      <!-- Piano keys will be generated here -->
    </div>

    <div class="frequency-display">
      <div class="current-note" id="current-note">Click a key to play</div>
      <div class="current-frequency" id="current-frequency">Frequency: -- Hz</div>
    </div>
  </div>

  <script>
    const freqTable = {
      432: [
        {
          note: "C0",
          frequency: 16.05,
        },
        {
          note: "C#0",
          frequency: 17.01,
        },
        {
          note: "D0",
          frequency: 18.02,
        },
        {
          note: "D#0",
          frequency: 19.09,
        },
        {
          note: "E0",
          frequency: 20.23,
        },
        {
          note: "F0",
          frequency: 21.43,
        },
        {
          note: "F#0",
          frequency: 22.7,
        },
        {
          note: "G0",
          frequency: 24.05,
        },
        {
          note: "G#0",
          frequency: 25.48,
        },
        {
          note: "A0",
          frequency: 27,
        },
        {
          note: "A#0",
          frequency: 28.61,
        },
        {
          note: "B0",
          frequency: 30.31,
        },
        {
          note: "C1",
          frequency: 32.11,
        },
        {
          note: "C#1",
          frequency: 34.02,
        },
        {
          note: "D1",
          frequency: 36.04,
        },
        {
          note: "D#1",
          frequency: 38.18,
        },
        {
          note: "E1",
          frequency: 40.45,
        },
        {
          note: "F1",
          frequency: 42.86,
        },
        {
          note: "F#1",
          frequency: 45.41,
        },
        {
          note: "G1",
          frequency: 48.11,
        },
        {
          note: "G#1",
          frequency: 50.97,
        },
        {
          note: "A1",
          frequency: 54,
        },
        {
          note: "A#1",
          frequency: 57.21,
        },
        {
          note: "B1",
          frequency: 60.61,
        },
        {
          note: "C2",
          frequency: 64.22,
        },
        {
          note: "C#2",
          frequency: 68.04,
        },
        {
          note: "D2",
          frequency: 72.08,
        },
        {
          note: "D#2",
          frequency: 76.37,
        },
        {
          note: "E2",
          frequency: 80.91,
        },
        {
          note: "F2",
          frequency: 85.72,
        },
        {
          note: "F#2",
          frequency: 90.82,
        },
        {
          note: "G2",
          frequency: 96.22,
        },
        {
          note: "G#2",
          frequency: 101.94,
        },
        {
          note: "A2",
          frequency: 108,
        },
        {
          note: "A#2",
          frequency: 114.42,
        },
        {
          note: "B2",
          frequency: 121.23,
        },
        {
          note: "C3",
          frequency: 128.43,
        },
        {
          note: "C#3",
          frequency: 136.07,
        },
        {
          note: "D3",
          frequency: 144.16,
        },
        {
          note: "D#3",
          frequency: 152.74,
        },
        {
          note: "E3",
          frequency: 161.82,
        },
        {
          note: "F3",
          frequency: 171.44,
        },
        {
          note: "F#3",
          frequency: 181.63,
        },
        {
          note: "G3",
          frequency: 192.43,
        },
        {
          note: "G#3",
          frequency: 203.88,
        },
        {
          note: "A3",
          frequency: 216,
        },
        {
          note: "A#3",
          frequency: 228.84,
        },
        {
          note: "B3",
          frequency: 242.45,
        },
        {
          note: "C4",
          frequency: 256.87,
        },
        {
          note: "C#4",
          frequency: 272.14,
        },
        {
          note: "D4",
          frequency: 288.33,
        },
        {
          note: "D#4",
          frequency: 305.47,
        },
        {
          note: "E4",
          frequency: 323.63,
        },
        {
          note: "F4",
          frequency: 342.88,
        },
        {
          note: "F#4",
          frequency: 363.27,
        },
        {
          note: "G4",
          frequency: 384.87,
        },
        {
          note: "G#4",
          frequency: 407.75,
        },
        {
          note: "A4",
          frequency: 432,
        },
        {
          note: "A#4",
          frequency: 457.69,
        },
        {
          note: "B4",
          frequency: 484.9,
        },
        {
          note: "C5",
          frequency: 513.74,
        },
        {
          note: "C#5",
          frequency: 544.29,
        },
        {
          note: "D5",
          frequency: 576.65,
        },
        {
          note: "D#5",
          frequency: 610.94,
        },
        {
          note: "E5",
          frequency: 647.27,
        },
        {
          note: "F5",
          frequency: 685.76,
        },
        {
          note: "F#5",
          frequency: 726.53,
        },
        {
          note: "G5",
          frequency: 769.74,
        },
        {
          note: "G#5",
          frequency: 815.51,
        },
        {
          note: "A5",
          frequency: 864,
        },
        {
          note: "A#5",
          frequency: 915.38,
        },
        {
          note: "B5",
          frequency: 969.81,
        },
        {
          note: "C6",
          frequency: 1027.47,
        },
        {
          note: "C#6",
          frequency: 1088.57,
        },
        {
          note: "D6",
          frequency: 1153.3,
        },
        {
          note: "D#6",
          frequency: 1221.88,
        },
        {
          note: "E6",
          frequency: 1294.54,
        },
        {
          note: "F6",
          frequency: 1371.51,
        },
        {
          note: "F#6",
          frequency: 1453.07,
        },
        {
          note: "G6",
          frequency: 1539.47,
        },
        {
          note: "G#6",
          frequency: 1631.01,
        },
        {
          note: "A6",
          frequency: 1728,
        },
        {
          note: "A#6",
          frequency: 1830.75,
        },
        {
          note: "B6",
          frequency: 1939.61,
        },
        {
          note: "C7",
          frequency: 2054.95,
        },
        {
          note: "C#7",
          frequency: 2177.14,
        },
        {
          note: "D7",
          frequency: 2306.6,
        },
        {
          note: "D#7",
          frequency: 2443.76,
        },
        {
          note: "E7",
          frequency: 2589.07,
        },
        {
          note: "F7",
          frequency: 2743.03,
        },
        {
          note: "F#7",
          frequency: 2906.14,
        },
        {
          note: "G7",
          frequency: 3078.95,
        },
        {
          note: "G#7",
          frequency: 3262.03,
        },
        {
          note: "A7",
          frequency: 3456,
        },
        {
          note: "A#7",
          frequency: 3661.5,
        },
        {
          note: "B7",
          frequency: 3879.23,
        },
        {
          note: "C8",
          frequency: 4109.9,
        },
        {
          note: "C#8",
          frequency: 4354.29,
        },
        {
          note: "D8",
          frequency: 4613.21,
        },
        {
          note: "D#8",
          frequency: 4887.52,
        },
        {
          note: "E8",
          frequency: 5178.15,
        },
        {
          note: "F8",
          frequency: 5486.06,
        },
        {
          note: "F#8",
          frequency: 5812.28,
        },
        {
          note: "G8",
          frequency: 6157.89,
        },
        {
          note: "G#8",
          frequency: 6524.06,
        },
        {
          note: "A8",
          frequency: 6912,
        },
        {
          note: "A#8",
          frequency: 7323.01,
        },
        {
          note: "B8",
          frequency: 7758.46,
        },
      ],
      434: [
        {
          note: "C0",
          frequency: 16.13,
        },
        {
          note: "C#0",
          frequency: 17.09,
        },
        {
          note: "D0",
          frequency: 18.1,
        },
        {
          note: "D#0",
          frequency: 19.18,
        },
        {
          note: "E0",
          frequency: 20.32,
        },
        {
          note: "F0",
          frequency: 21.53,
        },
        {
          note: "F#0",
          frequency: 22.81,
        },
        {
          note: "G0",
          frequency: 24.17,
        },
        {
          note: "G#0",
          frequency: 25.6,
        },
        {
          note: "A0",
          frequency: 27.12,
        },
        {
          note: "A#0",
          frequency: 28.74,
        },
        {
          note: "B0",
          frequency: 30.45,
        },
        {
          note: "C1",
          frequency: 32.26,
        },
        {
          note: "C#1",
          frequency: 34.18,
        },
        {
          note: "D1",
          frequency: 36.21,
        },
        {
          note: "D#1",
          frequency: 38.36,
        },
        {
          note: "E1",
          frequency: 40.64,
        },
        {
          note: "F1",
          frequency: 43.06,
        },
        {
          note: "F#1",
          frequency: 45.62,
        },
        {
          note: "G1",
          frequency: 48.33,
        },
        {
          note: "G#1",
          frequency: 51.21,
        },
        {
          note: "A1",
          frequency: 54.25,
        },
        {
          note: "A#1",
          frequency: 57.48,
        },
        {
          note: "B1",
          frequency: 60.89,
        },
        {
          note: "C2",
          frequency: 64.51,
        },
        {
          note: "C#2",
          frequency: 68.35,
        },
        {
          note: "D2",
          frequency: 72.42,
        },
        {
          note: "D#2",
          frequency: 76.72,
        },
        {
          note: "E2",
          frequency: 81.28,
        },
        {
          note: "F2",
          frequency: 86.12,
        },
        {
          note: "F#2",
          frequency: 91.24,
        },
        {
          note: "G2",
          frequency: 96.66,
        },
        {
          note: "G#2",
          frequency: 102.41,
        },
        {
          note: "A2",
          frequency: 108.5,
        },
        {
          note: "A#2",
          frequency: 114.95,
        },
        {
          note: "B2",
          frequency: 121.79,
        },
        {
          note: "C3",
          frequency: 129.03,
        },
        {
          note: "C#3",
          frequency: 136.7,
        },
        {
          note: "D3",
          frequency: 144.83,
        },
        {
          note: "D#3",
          frequency: 153.44,
        },
        {
          note: "E3",
          frequency: 162.57,
        },
        {
          note: "F3",
          frequency: 172.23,
        },
        {
          note: "F#3",
          frequency: 182.47,
        },
        {
          note: "G3",
          frequency: 193.32,
        },
        {
          note: "G#3",
          frequency: 204.82,
        },
        {
          note: "A3",
          frequency: 217,
        },
        {
          note: "A#3",
          frequency: 229.9,
        },
        {
          note: "B3",
          frequency: 243.57,
        },
        {
          note: "C4",
          frequency: 258.06,
        },
        {
          note: "C#4",
          frequency: 273.4,
        },
        {
          note: "D4",
          frequency: 289.66,
        },
        {
          note: "D#4",
          frequency: 306.88,
        },
        {
          note: "E4",
          frequency: 325.13,
        },
        {
          note: "F4",
          frequency: 344.47,
        },
        {
          note: "F#4",
          frequency: 364.95,
        },
        {
          note: "G4",
          frequency: 386.65,
        },
        {
          note: "G#4",
          frequency: 409.64,
        },
        {
          note: "A4",
          frequency: 434,
        },
        {
          note: "A#4",
          frequency: 459.81,
        },
        {
          note: "B4",
          frequency: 487.15,
        },
        {
          note: "C5",
          frequency: 516.12,
        },
        {
          note: "C#5",
          frequency: 546.81,
        },
        {
          note: "D5",
          frequency: 579.32,
        },
        {
          note: "D#5",
          frequency: 613.77,
        },
        {
          note: "E5",
          frequency: 650.27,
        },
        {
          note: "F5",
          frequency: 688.93,
        },
        {
          note: "F#5",
          frequency: 729.9,
        },
        {
          note: "G5",
          frequency: 773.3,
        },
        {
          note: "G#5",
          frequency: 819.28,
        },
        {
          note: "A5",
          frequency: 868,
        },
        {
          note: "A#5",
          frequency: 919.61,
        },
        {
          note: "B5",
          frequency: 974.3,
        },
        {
          note: "C6",
          frequency: 1032.23,
        },
        {
          note: "C#6",
          frequency: 1093.61,
        },
        {
          note: "D6",
          frequency: 1158.64,
        },
        {
          note: "D#6",
          frequency: 1227.54,
        },
        {
          note: "E6",
          frequency: 1300.53,
        },
        {
          note: "F6",
          frequency: 1377.86,
        },
        {
          note: "F#6",
          frequency: 1459.8,
        },
        {
          note: "G6",
          frequency: 1546.6,
        },
        {
          note: "G#6",
          frequency: 1638.57,
        },
        {
          note: "A6",
          frequency: 1736,
        },
        {
          note: "A#6",
          frequency: 1839.23,
        },
        {
          note: "B6",
          frequency: 1948.59,
        },
        {
          note: "C7",
          frequency: 2064.46,
        },
        {
          note: "C#7",
          frequency: 2187.22,
        },
        {
          note: "D7",
          frequency: 2317.28,
        },
        {
          note: "D#7",
          frequency: 2455.07,
        },
        {
          note: "E7",
          frequency: 2601.06,
        },
        {
          note: "F7",
          frequency: 2755.73,
        },
        {
          note: "F#7",
          frequency: 2919.59,
        },
        {
          note: "G7",
          frequency: 3093.2,
        },
        {
          note: "G#7",
          frequency: 3277.13,
        },
        {
          note: "A7",
          frequency: 3472,
        },
        {
          note: "A#7",
          frequency: 3678.46,
        },
        {
          note: "B7",
          frequency: 3897.19,
        },
        {
          note: "C8",
          frequency: 4128.93,
        },
        {
          note: "C#8",
          frequency: 4374.44,
        },
        {
          note: "D8",
          frequency: 4634.56,
        },
        {
          note: "D#8",
          frequency: 4910.15,
        },
        {
          note: "E8",
          frequency: 5202.12,
        },
        {
          note: "F8",
          frequency: 5511.46,
        },
        {
          note: "F#8",
          frequency: 5839.18,
        },
        {
          note: "G8",
          frequency: 6186.4,
        },
        {
          note: "G#8",
          frequency: 6554.26,
        },
        {
          note: "A8",
          frequency: 6944,
        },
        {
          note: "A#8",
          frequency: 7356.91,
        },
        {
          note: "B8",
          frequency: 7794.38,
        },
      ],
      436: [
        {
          note: "C0",
          frequency: 16.2,
        },
        {
          note: "C#0",
          frequency: 17.17,
        },
        {
          note: "D0",
          frequency: 18.19,
        },
        {
          note: "D#0",
          frequency: 19.27,
        },
        {
          note: "E0",
          frequency: 20.41,
        },
        {
          note: "F0",
          frequency: 21.63,
        },
        {
          note: "F#0",
          frequency: 22.91,
        },
        {
          note: "G0",
          frequency: 24.28,
        },
        {
          note: "G#0",
          frequency: 25.72,
        },
        {
          note: "A0",
          frequency: 27.25,
        },
        {
          note: "A#0",
          frequency: 28.87,
        },
        {
          note: "B0",
          frequency: 30.59,
        },
        {
          note: "C1",
          frequency: 32.41,
        },
        {
          note: "C#1",
          frequency: 34.33,
        },
        {
          note: "D1",
          frequency: 36.37,
        },
        {
          note: "D#1",
          frequency: 38.54,
        },
        {
          note: "E1",
          frequency: 40.83,
        },
        {
          note: "F1",
          frequency: 43.26,
        },
        {
          note: "F#1",
          frequency: 45.83,
        },
        {
          note: "G1",
          frequency: 48.55,
        },
        {
          note: "G#1",
          frequency: 51.44,
        },
        {
          note: "A1",
          frequency: 54.5,
        },
        {
          note: "A#1",
          frequency: 57.74,
        },
        {
          note: "B1",
          frequency: 61.17,
        },
        {
          note: "C2",
          frequency: 64.81,
        },
        {
          note: "C#2",
          frequency: 68.67,
        },
        {
          note: "D2",
          frequency: 72.75,
        },
        {
          note: "D#2",
          frequency: 77.07,
        },
        {
          note: "E2",
          frequency: 81.66,
        },
        {
          note: "F2",
          frequency: 86.51,
        },
        {
          note: "F#2",
          frequency: 91.66,
        },
        {
          note: "G2",
          frequency: 97.11,
        },
        {
          note: "G#2",
          frequency: 102.88,
        },
        {
          note: "A2",
          frequency: 109,
        },
        {
          note: "A#2",
          frequency: 115.48,
        },
        {
          note: "B2",
          frequency: 122.35,
        },
        {
          note: "C3",
          frequency: 129.62,
        },
        {
          note: "C#3",
          frequency: 137.33,
        },
        {
          note: "D3",
          frequency: 145.5,
        },
        {
          note: "D#3",
          frequency: 154.15,
        },
        {
          note: "E3",
          frequency: 163.32,
        },
        {
          note: "F3",
          frequency: 173.03,
        },
        {
          note: "F#3",
          frequency: 183.32,
        },
        {
          note: "G3",
          frequency: 194.22,
        },
        {
          note: "G#3",
          frequency: 205.76,
        },
        {
          note: "A3",
          frequency: 218,
        },
        {
          note: "A#3",
          frequency: 230.96,
        },
        {
          note: "B3",
          frequency: 244.7,
        },
        {
          note: "C4",
          frequency: 259.25,
        },
        {
          note: "C#4",
          frequency: 274.66,
        },
        {
          note: "D4",
          frequency: 290.99,
        },
        {
          note: "D#4",
          frequency: 308.3,
        },
        {
          note: "E4",
          frequency: 326.63,
        },
        {
          note: "F4",
          frequency: 346.05,
        },
        {
          note: "F#4",
          frequency: 366.63,
        },
        {
          note: "G4",
          frequency: 388.43,
        },
        {
          note: "G#4",
          frequency: 411.53,
        },
        {
          note: "A4",
          frequency: 436,
        },
        {
          note: "A#4",
          frequency: 461.93,
        },
        {
          note: "B4",
          frequency: 489.39,
        },
        {
          note: "C5",
          frequency: 518.49,
        },
        {
          note: "C#5",
          frequency: 549.33,
        },
        {
          note: "D5",
          frequency: 581.99,
        },
        {
          note: "D#5",
          frequency: 616.6,
        },
        {
          note: "E5",
          frequency: 653.26,
        },
        {
          note: "F5",
          frequency: 692.11,
        },
        {
          note: "F#5",
          frequency: 733.26,
        },
        {
          note: "G5",
          frequency: 776.86,
        },
        {
          note: "G#5",
          frequency: 823.06,
        },
        {
          note: "A5",
          frequency: 872,
        },
        {
          note: "A#5",
          frequency: 923.85,
        },
        {
          note: "B5",
          frequency: 978.79,
        },
        {
          note: "C6",
          frequency: 1036.99,
        },
        {
          note: "C#6",
          frequency: 1098.65,
        },
        {
          note: "D6",
          frequency: 1163.98,
        },
        {
          note: "D#6",
          frequency: 1233.19,
        },
        {
          note: "E6",
          frequency: 1306.52,
        },
        {
          note: "F6",
          frequency: 1384.21,
        },
        {
          note: "F#6",
          frequency: 1466.52,
        },
        {
          note: "G6",
          frequency: 1553.73,
        },
        {
          note: "G#6",
          frequency: 1646.12,
        },
        {
          note: "A6",
          frequency: 1744,
        },
        {
          note: "A#6",
          frequency: 1847.7,
        },
        {
          note: "B6",
          frequency: 1957.57,
        },
        {
          note: "C7",
          frequency: 2073.98,
        },
        {
          note: "C#7",
          frequency: 2197.3,
        },
        {
          note: "D7",
          frequency: 2327.96,
        },
        {
          note: "D#7",
          frequency: 2466.39,
        },
        {
          note: "E7",
          frequency: 2613.05,
        },
        {
          note: "F7",
          frequency: 2768.43,
        },
        {
          note: "F#7",
          frequency: 2933.05,
        },
        {
          note: "G7",
          frequency: 3107.45,
        },
        {
          note: "G#7",
          frequency: 3292.23,
        },
        {
          note: "A7",
          frequency: 3488,
        },
        {
          note: "A#7",
          frequency: 3695.41,
        },
        {
          note: "B7",
          frequency: 3915.15,
        },
        {
          note: "C8",
          frequency: 4147.95,
        },
        {
          note: "C#8",
          frequency: 4394.6,
        },
        {
          note: "D8",
          frequency: 4655.92,
        },
        {
          note: "D#8",
          frequency: 4932.78,
        },
        {
          note: "E8",
          frequency: 5226.09,
        },
        {
          note: "F8",
          frequency: 5536.85,
        },
        {
          note: "F#8",
          frequency: 5866.09,
        },
        {
          note: "G8",
          frequency: 6214.91,
        },
        {
          note: "G#8",
          frequency: 6584.47,
        },
        {
          note: "A8",
          frequency: 6976,
        },
        {
          note: "A#8",
          frequency: 7390.81,
        },
        {
          note: "B8",
          frequency: 7830.3,
        },
      ],
      440: [
        {
          note: "C0",
          frequency: 16.35,
        },
        {
          note: "C#0",
          frequency: 17.32,
        },
        {
          note: "D0",
          frequency: 18.35,
        },
        {
          note: "D#0",
          frequency: 19.45,
        },
        {
          note: "E0",
          frequency: 20.6,
        },
        {
          note: "F0",
          frequency: 21.83,
        },
        {
          note: "F#0",
          frequency: 23.12,
        },
        {
          note: "G0",
          frequency: 24.5,
        },
        {
          note: "G#0",
          frequency: 25.96,
        },
        {
          note: "A0",
          frequency: 27.5,
        },
        {
          note: "A#0",
          frequency: 29.14,
        },
        {
          note: "B0",
          frequency: 30.87,
        },
        {
          note: "C1",
          frequency: 32.7,
        },
        {
          note: "C#1",
          frequency: 34.65,
        },
        {
          note: "D1",
          frequency: 36.71,
        },
        {
          note: "D#1",
          frequency: 38.89,
        },
        {
          note: "E1",
          frequency: 41.2,
        },
        {
          note: "F1",
          frequency: 43.65,
        },
        {
          note: "F#1",
          frequency: 46.25,
        },
        {
          note: "G1",
          frequency: 49,
        },
        {
          note: "G#1",
          frequency: 51.91,
        },
        {
          note: "A1",
          frequency: 55,
        },
        {
          note: "A#1",
          frequency: 58.27,
        },
        {
          note: "B1",
          frequency: 61.74,
        },
        {
          note: "C2",
          frequency: 65.41,
        },
        {
          note: "C#2",
          frequency: 69.3,
        },
        {
          note: "D2",
          frequency: 73.42,
        },
        {
          note: "D#2",
          frequency: 77.78,
        },
        {
          note: "E2",
          frequency: 82.41,
        },
        {
          note: "F2",
          frequency: 87.31,
        },
        {
          note: "F#2",
          frequency: 92.5,
        },
        {
          note: "G2",
          frequency: 98,
        },
        {
          note: "G#2",
          frequency: 103.83,
        },
        {
          note: "A2",
          frequency: 110,
        },
        {
          note: "A#2",
          frequency: 116.54,
        },
        {
          note: "B2",
          frequency: 123.47,
        },
        {
          note: "C3",
          frequency: 130.81,
        },
        {
          note: "C#3",
          frequency: 138.59,
        },
        {
          note: "D3",
          frequency: 146.83,
        },
        {
          note: "D#3",
          frequency: 155.56,
        },
        {
          note: "E3",
          frequency: 164.81,
        },
        {
          note: "F3",
          frequency: 174.61,
        },
        {
          note: "F#3",
          frequency: 185,
        },
        {
          note: "G3",
          frequency: 196,
        },
        {
          note: "G#3",
          frequency: 207.65,
        },
        {
          note: "A3",
          frequency: 220,
        },
        {
          note: "A#3",
          frequency: 233.08,
        },
        {
          note: "B3",
          frequency: 246.94,
        },
        {
          note: "C4",
          frequency: 261.63,
        },
        {
          note: "C#4",
          frequency: 277.18,
        },
        {
          note: "D4",
          frequency: 293.66,
        },
        {
          note: "D#4",
          frequency: 311.13,
        },
        {
          note: "E4",
          frequency: 329.63,
        },
        {
          note: "F4",
          frequency: 349.23,
        },
        {
          note: "F#4",
          frequency: 369.99,
        },
        {
          note: "G4",
          frequency: 392,
        },
        {
          note: "G#4",
          frequency: 415.3,
        },
        {
          note: "A4",
          frequency: 440,
        },
        {
          note: "A#4",
          frequency: 466.16,
        },
        {
          note: "B4",
          frequency: 493.88,
        },
        {
          note: "C5",
          frequency: 523.25,
        },
        {
          note: "C#5",
          frequency: 554.37,
        },
        {
          note: "D5",
          frequency: 587.33,
        },
        {
          note: "D#5",
          frequency: 622.25,
        },
        {
          note: "E5",
          frequency: 659.25,
        },
        {
          note: "F5",
          frequency: 698.46,
        },
        {
          note: "F#5",
          frequency: 739.99,
        },
        {
          note: "G5",
          frequency: 783.99,
        },
        {
          note: "G#5",
          frequency: 830.61,
        },
        {
          note: "A5",
          frequency: 880,
        },
        {
          note: "A#5",
          frequency: 932.33,
        },
        {
          note: "B5",
          frequency: 987.77,
        },
        {
          note: "C6",
          frequency: 1046.5,
        },
        {
          note: "C#6",
          frequency: 1108.73,
        },
        {
          note: "D6",
          frequency: 1174.66,
        },
        {
          note: "D#6",
          frequency: 1244.51,
        },
        {
          note: "E6",
          frequency: 1318.51,
        },
        {
          note: "F6",
          frequency: 1396.91,
        },
        {
          note: "F#6",
          frequency: 1479.98,
        },
        {
          note: "G6",
          frequency: 1567.98,
        },
        {
          note: "G#6",
          frequency: 1661.22,
        },
        {
          note: "A6",
          frequency: 1760,
        },
        {
          note: "A#6",
          frequency: 1864.66,
        },
        {
          note: "B6",
          frequency: 1975.53,
        },
        {
          note: "C7",
          frequency: 2093,
        },
        {
          note: "C#7",
          frequency: 2217.46,
        },
        {
          note: "D7",
          frequency: 2349.32,
        },
        {
          note: "D#7",
          frequency: 2489.02,
        },
        {
          note: "E7",
          frequency: 2637.02,
        },
        {
          note: "F7",
          frequency: 2793.83,
        },
        {
          note: "F#7",
          frequency: 2959.96,
        },
        {
          note: "G7",
          frequency: 3135.96,
        },
        {
          note: "G#7",
          frequency: 3322.44,
        },
        {
          note: "A7",
          frequency: 3520,
        },
        {
          note: "A#7",
          frequency: 3729.31,
        },
        {
          note: "B7",
          frequency: 3951.07,
        },
        {
          note: "C8",
          frequency: 4186.01,
        },
        {
          note: "C#8",
          frequency: 4434.92,
        },
        {
          note: "D8",
          frequency: 4698.63,
        },
        {
          note: "D#8",
          frequency: 4978.03,
        },
        {
          note: "E8",
          frequency: 5274.04,
        },
        {
          note: "F8",
          frequency: 5587.65,
        },
        {
          note: "F#8",
          frequency: 5919.91,
        },
        {
          note: "G8",
          frequency: 6271.93,
        },
        {
          note: "G#8",
          frequency: 6644.88,
        },
        {
          note: "A8",
          frequency: 7040,
        },
        {
          note: "A#8",
          frequency: 7458.62,
        },
        {
          note: "B8",
          frequency: 7902.13,
        },
      ],
      442: [
        {
          note: "C0",
          frequency: 16.43,
        },
        {
          note: "C#0",
          frequency: 17.4,
        },
        {
          note: "D0",
          frequency: 18.44,
        },
        {
          note: "D#0",
          frequency: 19.53,
        },
        {
          note: "E0",
          frequency: 20.7,
        },
        {
          note: "F0",
          frequency: 21.93,
        },
        {
          note: "F#0",
          frequency: 23.23,
        },
        {
          note: "G0",
          frequency: 24.61,
        },
        {
          note: "G#0",
          frequency: 26.07,
        },
        {
          note: "A0",
          frequency: 27.62,
        },
        {
          note: "A#0",
          frequency: 29.27,
        },
        {
          note: "B0",
          frequency: 31.01,
        },
        {
          note: "C1",
          frequency: 32.85,
        },
        {
          note: "C#1",
          frequency: 34.81,
        },
        {
          note: "D1",
          frequency: 36.87,
        },
        {
          note: "D#1",
          frequency: 39.07,
        },
        {
          note: "E1",
          frequency: 41.39,
        },
        {
          note: "F1",
          frequency: 43.85,
        },
        {
          note: "F#1",
          frequency: 46.46,
        },
        {
          note: "G1",
          frequency: 49.22,
        },
        {
          note: "G#1",
          frequency: 52.15,
        },
        {
          note: "A1",
          frequency: 55.25,
        },
        {
          note: "A#1",
          frequency: 58.54,
        },
        {
          note: "B1",
          frequency: 62.02,
        },
        {
          note: "C2",
          frequency: 65.7,
        },
        {
          note: "C#2",
          frequency: 69.61,
        },
        {
          note: "D2",
          frequency: 73.75,
        },
        {
          note: "D#2",
          frequency: 78.14,
        },
        {
          note: "E2",
          frequency: 82.78,
        },
        {
          note: "F2",
          frequency: 87.7,
        },
        {
          note: "F#2",
          frequency: 92.92,
        },
        {
          note: "G2",
          frequency: 98.44,
        },
        {
          note: "G#2",
          frequency: 104.3,
        },
        {
          note: "A2",
          frequency: 110.5,
        },
        {
          note: "A#2",
          frequency: 117.07,
        },
        {
          note: "B2",
          frequency: 124.03,
        },
        {
          note: "C3",
          frequency: 131.41,
        },
        {
          note: "C#3",
          frequency: 139.22,
        },
        {
          note: "D3",
          frequency: 147.5,
        },
        {
          note: "D#3",
          frequency: 156.27,
        },
        {
          note: "E3",
          frequency: 165.56,
        },
        {
          note: "F3",
          frequency: 175.41,
        },
        {
          note: "F#3",
          frequency: 185.84,
        },
        {
          note: "G3",
          frequency: 196.89,
        },
        {
          note: "G#3",
          frequency: 208.6,
        },
        {
          note: "A3",
          frequency: 221,
        },
        {
          note: "A#3",
          frequency: 234.14,
        },
        {
          note: "B3",
          frequency: 248.06,
        },
        {
          note: "C4",
          frequency: 262.81,
        },
        {
          note: "C#4",
          frequency: 278.44,
        },
        {
          note: "D4",
          frequency: 295,
        },
        {
          note: "D#4",
          frequency: 312.54,
        },
        {
          note: "E4",
          frequency: 331.13,
        },
        {
          note: "F4",
          frequency: 350.82,
        },
        {
          note: "F#4",
          frequency: 371.68,
        },
        {
          note: "G4",
          frequency: 393.78,
        },
        {
          note: "G#4",
          frequency: 417.19,
        },
        {
          note: "A4",
          frequency: 442,
        },
        {
          note: "A#4",
          frequency: 468.28,
        },
        {
          note: "B4",
          frequency: 496.13,
        },
        {
          note: "C5",
          frequency: 525.63,
        },
        {
          note: "C#5",
          frequency: 556.88,
        },
        {
          note: "D5",
          frequency: 590,
        },
        {
          note: "D#5",
          frequency: 625.08,
        },
        {
          note: "E5",
          frequency: 662.25,
        },
        {
          note: "F5",
          frequency: 701.63,
        },
        {
          note: "F#5",
          frequency: 743.35,
        },
        {
          note: "G5",
          frequency: 787.55,
        },
        {
          note: "G#5",
          frequency: 834.38,
        },
        {
          note: "A5",
          frequency: 884,
        },
        {
          note: "A#5",
          frequency: 936.57,
        },
        {
          note: "B5",
          frequency: 992.26,
        },
        {
          note: "C6",
          frequency: 1051.26,
        },
        {
          note: "C#6",
          frequency: 1113.77,
        },
        {
          note: "D6",
          frequency: 1180,
        },
        {
          note: "D#6",
          frequency: 1250.16,
        },
        {
          note: "E6",
          frequency: 1324.5,
        },
        {
          note: "F6",
          frequency: 1403.26,
        },
        {
          note: "F#6",
          frequency: 1486.7,
        },
        {
          note: "G6",
          frequency: 1575.11,
        },
        {
          note: "G#6",
          frequency: 1668.77,
        },
        {
          note: "A6",
          frequency: 1768,
        },
        {
          note: "A#6",
          frequency: 1873.13,
        },
        {
          note: "B6",
          frequency: 1984.51,
        },
        {
          note: "C7",
          frequency: 2102.52,
        },
        {
          note: "C#7",
          frequency: 2227.54,
        },
        {
          note: "D7",
          frequency: 2360,
        },
        {
          note: "D#7",
          frequency: 2500.33,
        },
        {
          note: "E7",
          frequency: 2649.01,
        },
        {
          note: "F7",
          frequency: 2806.52,
        },
        {
          note: "F#7",
          frequency: 2973.41,
        },
        {
          note: "G7",
          frequency: 3150.22,
        },
        {
          note: "G#7",
          frequency: 3337.54,
        },
        {
          note: "A7",
          frequency: 3520,
        },
        {
          note: "A#7",
          frequency: 3729.31,
        },
        {
          note: "B7",
          frequency: 3951.07,
        },
        {
          note: "C8",
          frequency: 4186.01,
        },
        {
          note: "C#8",
          frequency: 4434.92,
        },
        {
          note: "D8",
          frequency: 4698.63,
        },
        {
          note: "D#8",
          frequency: 4978.03,
        },
        {
          note: "E8",
          frequency: 5274.04,
        },
        {
          note: "F8",
          frequency: 5587.65,
        },
        {
          note: "F#8",
          frequency: 5919.91,
        },
        {
          note: "G8",
          frequency: 6271.93,
        },
        {
          note: "G#8",
          frequency: 6644.88,
        },
        {
          note: "A8",
          frequency: 7040,
        },
        {
          note: "A#8",
          frequency: 7458.62,
        },
        {
          note: "B8",
          frequency: 7902.13,
        },
      ],
      444: [
        {
          note: "C0",
          frequency: 16.5,
        },
        {
          note: "C#0",
          frequency: 17.48,
        },
        {
          note: "D0",
          frequency: 18.52,
        },
        {
          note: "D#0",
          frequency: 19.62,
        },
        {
          note: "E0",
          frequency: 20.79,
        },
        {
          note: "F0",
          frequency: 22.03,
        },
        {
          note: "F#0",
          frequency: 23.33,
        },
        {
          note: "G0",
          frequency: 24.72,
        },
        {
          note: "G#0",
          frequency: 26.19,
        },
        {
          note: "A0",
          frequency: 27.75,
        },
        {
          note: "A#0",
          frequency: 29.4,
        },
        {
          note: "B0",
          frequency: 31.15,
        },
        {
          note: "C1",
          frequency: 33,
        },
        {
          note: "C#1",
          frequency: 34.96,
        },
        {
          note: "D1",
          frequency: 37.04,
        },
        {
          note: "D#1",
          frequency: 39.24,
        },
        {
          note: "E1",
          frequency: 41.58,
        },
        {
          note: "F1",
          frequency: 44.05,
        },
        {
          note: "F#1",
          frequency: 46.67,
        },
        {
          note: "G1",
          frequency: 49.44,
        },
        {
          note: "G#1",
          frequency: 52.39,
        },
        {
          note: "A1",
          frequency: 55.5,
        },
        {
          note: "A#1",
          frequency: 58.8,
        },
        {
          note: "B1",
          frequency: 62.3,
        },
        {
          note: "C2",
          frequency: 66,
        },
        {
          note: "C#2",
          frequency: 69.93,
        },
        {
          note: "D2",
          frequency: 74.08,
        },
        {
          note: "D#2",
          frequency: 78.49,
        },
        {
          note: "E2",
          frequency: 83.16,
        },
        {
          note: "F2",
          frequency: 88.1,
        },
        {
          note: "F#2",
          frequency: 93.34,
        },
        {
          note: "G2",
          frequency: 98.89,
        },
        {
          note: "G#2",
          frequency: 104.77,
        },
        {
          note: "A2",
          frequency: 111,
        },
        {
          note: "A#2",
          frequency: 117.6,
        },
        {
          note: "B2",
          frequency: 124.59,
        },
        {
          note: "C3",
          frequency: 132,
        },
        {
          note: "C#3",
          frequency: 139.85,
        },
        {
          note: "D3",
          frequency: 148.17,
        },
        {
          note: "D#3",
          frequency: 156.98,
        },
        {
          note: "E3",
          frequency: 166.31,
        },
        {
          note: "F3",
          frequency: 176.2,
        },
        {
          note: "F#3",
          frequency: 186.68,
        },
        {
          note: "G3",
          frequency: 197.78,
        },
        {
          note: "G#3",
          frequency: 209.54,
        },
        {
          note: "A3",
          frequency: 222,
        },
        {
          note: "A#3",
          frequency: 235.2,
        },
        {
          note: "B3",
          frequency: 249.19,
        },
        {
          note: "C4",
          frequency: 264,
        },
        {
          note: "C#4",
          frequency: 279.7,
        },
        {
          note: "D4",
          frequency: 296.33,
        },
        {
          note: "D#4",
          frequency: 313.96,
        },
        {
          note: "E4",
          frequency: 332.62,
        },
        {
          note: "F4",
          frequency: 352.4,
        },
        {
          note: "F#4",
          frequency: 373.36,
        },
        {
          note: "G4",
          frequency: 395.56,
        },
        {
          note: "G#4",
          frequency: 419.08,
        },
        {
          note: "A4",
          frequency: 444,
        },
        {
          note: "A#4",
          frequency: 470.4,
        },
        {
          note: "B4",
          frequency: 498.37,
        },
        {
          note: "C5",
          frequency: 528.01,
        },
        {
          note: "C#5",
          frequency: 559.4,
        },
        {
          note: "D5",
          frequency: 592.67,
        },
        {
          note: "D#5",
          frequency: 627.91,
        },
        {
          note: "E5",
          frequency: 665.25,
        },
        {
          note: "F5",
          frequency: 704.81,
        },
        {
          note: "F#5",
          frequency: 746.72,
        },
        {
          note: "G5",
          frequency: 791.12,
        },
        {
          note: "G#5",
          frequency: 838.16,
        },
        {
          note: "A5",
          frequency: 888,
        },
        {
          note: "A#5",
          frequency: 940.8,
        },
        {
          note: "B5",
          frequency: 996.75,
        },
        {
          note: "C6",
          frequency: 1056.02,
        },
        {
          note: "C#6",
          frequency: 1118.81,
        },
        {
          note: "D6",
          frequency: 1185.34,
        },
        {
          note: "D#6",
          frequency: 1255.82,
        },
        {
          note: "E6",
          frequency: 1330.5,
        },
        {
          note: "F6",
          frequency: 1415.96,
        },
        {
          note: "F#6",
          frequency: 1500.16,
        },
        {
          note: "G6",
          frequency: 1589.36,
        },
        {
          note: "G#6",
          frequency: 1683.87,
        },
        {
          note: "A6",
          frequency: 1784,
        },
        {
          note: "A#6",
          frequency: 1890.08,
        },
        {
          note: "B6",
          frequency: 2002.47,
        },
        {
          note: "C7",
          frequency: 2121.54,
        },
        {
          note: "C#7",
          frequency: 2247.7,
        },
        {
          note: "D7",
          frequency: 2381.35,
        },
        {
          note: "D#7",
          frequency: 2522.96,
        },
        {
          note: "E7",
          frequency: 2672.98,
        },
        {
          note: "F7",
          frequency: 2831.92,
        },
        {
          note: "F#7",
          frequency: 3000.32,
        },
        {
          note: "G7",
          frequency: 3178.73,
        },
        {
          note: "G#7",
          frequency: 3367.74,
        },
        {
          note: "A7",
          frequency: 3552,
        },
        {
          note: "A#7",
          frequency: 3763.21,
        },
        {
          note: "B7",
          frequency: 3986.99,
        },
        {
          note: "C8",
          frequency: 4224.06,
        },
        {
          note: "C#8",
          frequency: 4475.24,
        },
        {
          note: "D8",
          frequency: 4741.35,
        },
        {
          note: "D#8",
          frequency: 5023.29,
        },
        {
          note: "E8",
          frequency: 5321.99,
        },
        {
          note: "F8",
          frequency: 5638.45,
        },
        {
          note: "F#8",
          frequency: 5973.73,
        },
        {
          note: "G8",
          frequency: 6328.94,
        },
        {
          note: "G#8",
          frequency: 6705.28,
        },
        {
          note: "A8",
          frequency: 7104,
        },
        {
          note: "A#8",
          frequency: 7526.43,
        },
        {
          note: "B8",
          frequency: 7973.97,
        },
      ],
    };

    var baseFreq = 440,
      currentNodeIndex = 57, // A4 in the array of notes
      isRefSoundPlaying = false; // Add missing variable

    // Remove duplicate audioContext declaration - will be created in HTML
    var notesArray = freqTable[baseFreq];
    // Remove oscillator initialization - will be created on demand

    // Toggle reference sound on/off
    var toggleReferenceSound = function () {
      if (!audioContext) {
        console.log('AudioContext not initialized');
        return;
      }

      if (isRefSoundPlaying && sourceAudioNode) {
        try {
          sourceAudioNode.stop();
        } catch (e) {
          // Oscillator already stopped
        }
        sourceAudioNode = null;
        isRefSoundPlaying = false;
      } else {
        sourceAudioNode = audioContext.createOscillator();
        sourceAudioNode.frequency.value = notesArray[currentNodeIndex].frequency;
        sourceAudioNode.connect(audioContext.destination);
        sourceAudioNode.start();
        isRefSoundPlaying = true;
      }
    };

    // Function to play a single note by frequency
    var playFrequency = function (frequency, duration = 1000) {
      if (!audioContext) {
        console.log('AudioContext not initialized');
        return null;
      }

      var oscillator = audioContext.createOscillator();
      var gainNode = audioContext.createGain();

      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);

      oscillator.frequency.value = frequency;
      oscillator.type = 'sine';
      gainNode.gain.value = 0.3;

      oscillator.start();
      oscillator.stop(audioContext.currentTime + (duration / 1000));

      return oscillator;
    };

    // This function is called passing either a +2 or a -2 to increase or decrease
    // the A4 frequency we are using as a reference
    var changeBaseFreq = function (delta) {
      var newBaseFreq = baseFreq + delta;
      if (newBaseFreq >= 432 && newBaseFreq <= 446) {
        baseFreq = newBaseFreq;
        notesArray = freqTable[baseFreq.toString()];

        // We set this flag to 'true' when the reference sound feature is enabled
        if (isRefSoundPlaying && sourceAudioNode) {
          // Only change the frequency if we are playing a reference sound, since
          // sourceAudioNode will be an instance of OscillatorNode
          var newNoteFreq = notesArray[currentNodeIndex].frequency;
          try {
            sourceAudioNode.frequency.value = newNoteFreq;
          } catch (e) {
            // Handle error if oscillator is no longer active
            console.log('Could not change frequency:', e);
          }
        }
      }
    };

    // This function is used to change the note we are currently playing, using
    // whatever the current set of notes is (changed by the function above)
    var changeReferenceSoundNote = function (delta) {
      if (isRefSoundPlaying && sourceAudioNode) {
        var newNoteIndex = currentNodeIndex + delta;
        if (newNoteIndex >= 0 && newNoteIndex < notesArray.length) {
          currentNodeIndex = newNoteIndex;
          var newNoteFreq = notesArray[currentNodeIndex].frequency;
          try {
            sourceAudioNode.frequency.value = newNoteFreq;
          } catch (e) {
            // Handle error if oscillator is no longer active
            console.log('Could not change note:', e);
          }
        }
      }
    };




    // Piano UI and interaction logic
    let currentOctave = 4;
    let audioContext;
    let gainNode;
    let activeOscillators = new Map(); // Track multiple playing notes
    let pressedKeys = new Set(); // Track currently pressed keys
    let pressedMouseKeys = new Set(); // Track mouse-pressed keys

    // Note layout for piano keys with correct positions
    const noteLayout = [
      { note: 'C', type: 'white', position: 0 },
      { note: 'C#', type: 'black', position: 35 },
      { note: 'D', type: 'white', position: 52 },
      { note: 'D#', type: 'black', position: 87 },
      { note: 'E', type: 'white', position: 104 },
      { note: 'F', type: 'white', position: 156 },
      { note: 'F#', type: 'black', position: 191 },
      { note: 'G', type: 'white', position: 208 },
      { note: 'G#', type: 'black', position: 243 },
      { note: 'A', type: 'white', position: 260 },
      { note: 'A#', type: 'black', position: 295 },
      { note: 'B', type: 'white', position: 312 }
    ];

    // Initialize audio context
    function initAudio() {
      if (audioContext) return; // Already initialized

      try {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        gainNode = audioContext.createGain();
        gainNode.connect(audioContext.destination);
        gainNode.gain.value = 0.3; // Default volume

        console.log('AudioContext initialized successfully');

        // Update global variables for index.js compatibility
        window.audioContext = audioContext;
      } catch (e) {
        console.error('Web Audio API not supported:', e);
        alert('Sorry, your browser does not support Web Audio API. Please use a modern browser.');
      }
    }

    // Generate piano keys
    function generatePiano() {
      const piano = document.getElementById('piano');
      piano.innerHTML = '';

      noteLayout.forEach(noteInfo => {
        const key = document.createElement('div');
        key.className = `key ${noteInfo.type}-key`;
        key.dataset.note = noteInfo.note;
        key.dataset.octave = currentOctave;
        key.textContent = noteInfo.note;
        key.style.left = `${noteInfo.position}px`;

        key.addEventListener('mousedown', (e) => handleKeyPress(e, noteInfo.note));
        key.addEventListener('mouseup', (e) => handleKeyRelease(e, noteInfo.note));
        key.addEventListener('mouseleave', (e) => handleKeyRelease(e, noteInfo.note));

        piano.appendChild(key);
      });
    }

    // Handle key press with simplified modifier detection
    function handleKeyPress(event, note) {
      event.preventDefault();

      // Track that this key is being pressed via mouse
      pressedMouseKeys.add(note);

      // Just play the note
      playNote(note, currentOctave, event.target);
    }

    // Handle key release
    function handleKeyRelease(event, note) {
      // Remove from pressed mouse keys
      pressedMouseKeys.delete(note);

      const noteKey = `${note}${currentOctave}`;
      stopNote(noteKey, event.target);
    }

    // Play a note (supports multiple simultaneous notes)
    function playNote(note, octave, keyElement) {
      // Initialize audio context on first interaction
      if (!audioContext) {
        initAudio();
      }

      // Resume audio context if suspended
      if (audioContext && audioContext.state === 'suspended') {
        audioContext.resume().then(() => {
          console.log('AudioContext resumed');
        }).catch(e => {
          console.error('Failed to resume AudioContext:', e);
        });
      }

      const noteKey = `${note}${octave}`;

      // Don't play if already playing
      if (activeOscillators.has(noteKey)) {
        return;
      }

      // Find frequency from the frequency table
      const noteData = findNoteInTable(noteKey);

      if (noteData && audioContext) {
        try {
          // Create oscillator for this note
          const oscillator = audioContext.createOscillator();
          const noteGain = audioContext.createGain();

          oscillator.connect(noteGain);
          noteGain.connect(gainNode);

          // Set frequency and waveform
          oscillator.frequency.value = noteData.frequency;
          oscillator.type = 'sine';
          noteGain.gain.value = 0.3;

          // Add visual feedback
          keyElement.classList.add('playing');

          // Update display
          updateDisplay(noteKey, noteData.frequency);

          // Start playing
          oscillator.start();

          // Store the oscillator and gain node
          activeOscillators.set(noteKey, {
            oscillator,
            gainNode: noteGain,
            keyElement
          });

          // Auto-stop after 5 seconds (increased for polyphony)
          setTimeout(() => {
            if (activeOscillators.has(noteKey)) {
              stopNote(noteKey, keyElement);
            }
          }, 5000);
        } catch (e) {
          console.error('Error playing note:', e);
        }
      } else if (!noteData) {
        console.warn(`Note ${noteKey} not found in frequency table`);
      }
    }

    // Stop a specific note
    function stopNote(noteKey, keyElement) {
      if (activeOscillators.has(noteKey)) {
        const noteData = activeOscillators.get(noteKey);
        try {
          noteData.oscillator.stop();
        } catch (e) {
          // Oscillator already stopped
        }

        // Remove visual feedback
        if (noteData.keyElement) {
          noteData.keyElement.classList.remove('playing');
        }

        activeOscillators.delete(noteKey);
      }
    }

    // Stop all notes
    function stopAllNotes() {
      activeOscillators.forEach((noteData, noteKey) => {
        try {
          noteData.oscillator.stop();
        } catch (e) {
          // Oscillator already stopped
        }
        if (noteData.keyElement) {
          noteData.keyElement.classList.remove('playing');
        }
      });
      activeOscillators.clear();
    }

    // Find note in frequency table
    function findNoteInTable(noteWithOctave) {
      const currentFreqTable = freqTable[baseFreq] || freqTable[440];
      return currentFreqTable.find(item => item.note === noteWithOctave);
    }

    // Update octave display and button states
    function updateOctaveDisplay() {
      document.getElementById('current-octave').textContent = currentOctave;

      // Update button states
      const downBtn = document.getElementById('octave-down');
      const upBtn = document.getElementById('octave-up');

      downBtn.disabled = currentOctave <= 0;
      upBtn.disabled = currentOctave >= 8;
    }

    // Change octave function with note continuity
    function changeOctave(direction) {
      const newOctave = currentOctave + direction;
      if (newOctave >= 0 && newOctave <= 8) {
        // Get currently playing notes before changing octave
        const currentlyPlayingNotes = [];

        // Check keyboard pressed keys
        pressedKeys.forEach(key => {
          const keyMap = {
            'a': 'C', 'w': 'C#', 's': 'D', 'e': 'D#', 'd': 'E', 'f': 'F',
            't': 'F#', 'g': 'G', 'y': 'G#', 'h': 'A', 'u': 'A#', 'j': 'B'
          };
          const note = keyMap[key.toLowerCase()];
          if (note) {
            currentlyPlayingNotes.push({
              note: note,
              source: 'keyboard',
              element: document.querySelector(`[data-note="${note}"]`)
            });
          }
        });

        // Check mouse pressed keys
        pressedMouseKeys.forEach(note => {
          currentlyPlayingNotes.push({
            note: note,
            source: 'mouse',
            element: document.querySelector(`[data-note="${note}"]`)
          });
        });

        // Stop all current notes
        stopAllNotes();

        // Change octave
        currentOctave = newOctave;
        updateOctaveDisplay();
        generatePiano();

        // Restart notes in new octave after a brief delay
        setTimeout(() => {
          currentlyPlayingNotes.forEach(noteInfo => {
            const newElement = document.querySelector(`[data-note="${noteInfo.note}"]`);
            if (newElement) {
              playNote(noteInfo.note, currentOctave, newElement);
            }
          });
        }, 50); // Small delay to ensure clean transition
      }
    }

    // Setup octave controls
    function setupOctaveControls() {
      const downBtn = document.getElementById('octave-down');
      const upBtn = document.getElementById('octave-up');

      downBtn.addEventListener('click', () => changeOctave(-1));
      upBtn.addEventListener('click', () => changeOctave(1));

      // Update initial button states
      updateOctaveDisplay();
    }

    // Update note and frequency display
    function updateDisplay(note, frequency) {
      document.getElementById('current-note').textContent = note;
      document.getElementById('current-frequency').textContent = `Frequency: ${frequency.toFixed(2)} Hz`;
    }

    // Volume control
    function setupVolumeControl() {
      const volumeSlider = document.getElementById('volume');
      const volumeValue = document.getElementById('volume-value');

      volumeSlider.addEventListener('input', (e) => {
        const volume = e.target.value / 100;
        if (gainNode) {
          gainNode.gain.value = volume;
        }
        volumeValue.textContent = `${e.target.value}%`;
      });
    }

    // Keyboard support with improved octave controls
    function setupKeyboardSupport() {
      const keyMap = {
        'a': 'C',
        'w': 'C#',
        's': 'D',
        'e': 'D#',
        'd': 'E',
        'f': 'F',
        't': 'F#',
        'g': 'G',
        'y': 'G#',
        'h': 'A',
        'u': 'A#',
        'j': 'B'
      };

      document.addEventListener('keydown', (e) => {
        if (pressedKeys.has(e.key)) return; // Prevent repeat
        pressedKeys.add(e.key);

        const note = keyMap[e.key.toLowerCase()];
        if (note) {
          const keyElement = document.querySelector(`[data-note="${note}"]`);
          if (keyElement) {
            playNote(note, currentOctave, keyElement);
          }
        }

        // Improved octave controls - work even while playing
        if (e.key === 'ArrowUp') {
          e.preventDefault();
          changeOctave(1);
        } else if (e.key === 'ArrowDown') {
          e.preventDefault();
          changeOctave(-1);
        }

        // Space bar to stop all notes
        if (e.key === ' ') {
          e.preventDefault();
          stopAllNotes();
        }

        // Additional octave shortcuts
        if (e.key === '+' || e.key === '=') {
          e.preventDefault();
          changeOctave(1);
        } else if (e.key === '-') {
          e.preventDefault();
          changeOctave(-1);
        }
      });

      document.addEventListener('keyup', (e) => {
        pressedKeys.delete(e.key);
        const note = keyMap[e.key.toLowerCase()];
        if (note) {
          const noteKey = `${note}${currentOctave}`;
          const keyElement = document.querySelector(`[data-note="${note}"]`);
          stopNote(noteKey, keyElement);
        }
      });
    }

    // Initialize everything when the page loads
    document.addEventListener('DOMContentLoaded', () => {
      generatePiano();
      setupOctaveControls();
      setupVolumeControl();
      setupKeyboardSupport();

      // Add click handler to initialize audio context on first interaction
      document.addEventListener('click', () => {
        if (!audioContext) {
          initAudio();
        }
      }, { once: true });

      // Also try to initialize on any user interaction
      ['mousedown', 'keydown', 'touchstart'].forEach(eventType => {
        document.addEventListener(eventType, () => {
          if (!audioContext) {
            initAudio();
          }
        }, { once: true });
      });
    });
  </script>
</body>

</html>
